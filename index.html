<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Basic metadata -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lone Star Immunity | Data Visualization | Kiron Ang</title>
  <meta name="author" content="Kiron Ang" />

  <!-- Favicon: a small blue star SVG embedded directly -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpolygon points='12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9' fill='%230056a9'/%3E%3C/svg%3E" />
  
  <!-- Load D3.js library from CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- CSS STYLING SECTION -->
  <style>
    /* Define custom color variables for easy reuse */
    :root {
      --blue: #0056a9;
      --white: #ffffff;
      --red: #d90d0d;
    }

    /* Reset box sizing and remove default margin/padding */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Set up the body layout */
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-family: sans-serif;
      background: var(--white);
      color: var(--blue);
      text-align: center;
    }

    /* Style the main heading */
    h1 {
      font-size: 2.2rem;
      margin: 1rem 0 0.5rem;
    }

    /* Style the introduction paragraph */
    .intro {
      max-width: 800px;
      margin: 0 auto 1.5rem;
      padding: 0 1rem;
      font-size: 1rem;
    }

    /* Style links in the intro */
    .intro a {
      color: var(--blue);
      text-decoration: underline;
    }

    /* Footer style */
    footer {
      margin-top: auto;
      padding: 1rem;
      font-size: 0.85rem;
    }

    /* Controls section (input + suggestions + info card) */
    #controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      width: 100%;
    }

    /* Input field styling */
    #district-input {
      width: 90%;
      max-width: 400px;
      padding: 0.5rem;
      font-size: 1rem;
      border: 2px solid var(--blue);
      border-radius: 4px;
    }

    /* Highlight input when focused */
    #district-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 86, 169, 0.3);
    }

    /* Suggestions dropdown */
    #suggestions {
      list-style: none;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--blue);
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      background: var(--white);
      position: relative;
      z-index: 10;
    }

    /* Individual suggestion items */
    #suggestions li {
      padding: 0.5rem;
      cursor: pointer;
    }

    /* Highlight on hover or when active */
    #suggestions li:hover,
    #suggestions li.active {
      background: var(--blue);
      color: var(--white);
    }

    /* Info card showing district details */
    .info-card {
      width: 90%;
      max-width: 400px;
      border-left: 4px solid var(--blue);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      text-align: left;
      font-size: 0.95rem;
    }

    /* Red label text */
    .label {
      font-weight: bold;
      color: var(--red);
    }

    /* Legend explaining chart colors */
    .legend {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1rem;
      font-size: 0.9rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .legend-box {
      width: 15px;
      height: 15px;
      display: inline-block;
    }

    /* Chart container */
    #chart-container {
      width: 80%;
      margin: 0 auto;
      overflow-x: auto;
    }

    #chart {
      width: 100%;
      height: 500px;
    }

    /* Bar styles */
    .bar {
      fill: var(--blue);
    }

    .bar.low {
      fill: var(--red);
    }

    /* Axis styles */
    .axis path,
    .axis line {
      stroke: var(--blue);
    }

    .axis text {
      fill: var(--blue);
      font-size: 0.9rem;
    }

    /* Message section below chart */
    #message {
      padding: 0.75rem;
      font-size: 1rem;
    }

    /* Tooltip style (on hover) */
    #tooltip {
      position: absolute;
      pointer-events: none;
      padding: 4px 8px;
      font-size: 0.85rem;
      background: var(--white);
      border: 1px solid var(--blue);
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
      white-space: nowrap;
      z-index: 1000;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      #chart {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Main heading -->
  <h1>Lone Star Immunity</h1>

  <!-- Introductory paragraph -->
  <p class="intro">
    This website visualizes <strong>Texas school district vaccination data (2023–2024)</strong>.
    Type a district name below to see seventh-grade vaccination coverage.
    <br />
    <a href="https://www.dshs.texas.gov/immunizations/data/school/coverage" target="_blank">Texas Health Data</a> |
    <a href="https://github.com/kiron-ang/lonestarimmunity" target="_blank">GitHub Code</a>
  </p>

  <!-- Input controls and info -->
  <div id="controls">
    <input type="text" id="district-input" autocomplete="off" />
    <ul id="suggestions"></ul>
    <div id="info-panel" class="info-card">
      <span class="label">Please type and choose a district name to see more information!</span>
    </div>
  </div>

  <!-- Legend explaining chart -->
  <div class="legend">
    <div class="legend-item"><span class="legend-box" style="background: var(--blue);"></span> ≥95%</div>
    <div class="legend-item"><span class="legend-box" style="background: var(--red);"></span> &lt;95%</div>
  </div>

  <!-- Chart container -->
  <div id="chart-container">
    <svg id="chart"></svg>
  </div>

  <!-- Message display -->
  <div id="message"></div>

  <!-- Footer -->
  <footer>
    <p>© Kiron Ang</p>
  </footer>

  <!-- JAVASCRIPT + D3 SECTION -->
  <script>
    // Initialize tooltip div and SVG chart area
    const tooltip = d3.select("body").append("div").attr("id", "tooltip");
    const svg = d3.select("#chart");

    // Define chart margins and dimensions
    const margin = { top: 20, right: 30, bottom: 40, left: 150 };
    const width = svg.node().clientWidth - margin.left - margin.right;
    const height = svg.node().clientHeight - margin.top - margin.bottom;

    // Add group container with transform for margins
    const g = svg.attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                 .append("g")
                 .attr("transform", `translate(${margin.left},${margin.top})`);

    // Define scales
    const y = d3.scaleBand().padding(0.2).range([0, height]);
    const x = d3.scaleLinear().range([0, width]);

    // Add axes groups
    const xAxisG = g.append("g").attr("class", "axis").attr("transform", `translate(0,${height})`);
    const yAxisG = g.append("g").attr("class", "axis");

    // Load CSV data (assumes file is named 'data.csv' next to index.html)
    d3.csv("data.csv", d => {
      Object.keys(d).forEach(k => {
        if (d[k].endsWith("%")) d[k] = +d[k].replace("%", "");
      });
      d["Facility Name"] = d["Facility Name"].toUpperCase();
      return d;
    }).then(data => {
      const vaccineCols = data.columns.slice(5);  // vaccine columns
      const names = [...new Set(data.map(d => d["Facility Name"]))];  // unique district names
      const input = d3.select("#district-input");
      const sugg = d3.select("#suggestions");
      let activeIndex = -1;

      // Listen for input events (live search suggestions)
      input.on("input", function() {
        const val = this.value.toUpperCase();
        const filtered = names.filter(n => n.includes(val)).slice(0, 10);
        sugg.selectAll("li").remove();
        activeIndex = -1;

        if (val) {
          sugg.selectAll("li")
               .data(filtered)
               .enter()
               .append("li")
               .text(d => d)
               .on("click", (_, d) => {
                 input.property("value", d);
                 sugg.selectAll("li").remove();
                 updateAll(data.find(r => r["Facility Name"] === d));
               });
        }
      });

      // Handle keyboard navigation (up/down + enter)
      input.on("keydown", e => {
        const items = sugg.selectAll("li").nodes();
        if (!items.length) return;

        if (e.key === "ArrowDown") activeIndex = (activeIndex + 1) % items.length;
        if (e.key === "ArrowUp") activeIndex = (activeIndex - 1 + items.length) % items.length;
        if (e.key === "Enter" && activeIndex >= 0) {
          const d = items[activeIndex].textContent;
          input.property("value", d);
          sugg.selectAll("li").remove();
          updateAll(data.find(r => r["Facility Name"] === d));
        }
        items.forEach((item, i) => item.classList.toggle("active", i === activeIndex));
      });

      // Initialize with default district (e.g., McAllen ISD at row 823)
      updateAll(data[823]);

      // Main updater: updates info + chart
      function updateAll(row) {
        updateInfoPanel(row);
        updateChart(row);
      }

      // Update the info card panel
      function updateInfoPanel(d) {
        d3.select("#info-panel").html(`
          <div><span class="label">District:</span> ${d["Facility Name"]}</div>
          <div><span class="label">County:</span> ${d.County}</div>
          <div><span class="label">Type:</span> ${d["School Type"]}</div>
          <div><span class="label">Note:</span> Texas recommends ≥95% coverage for herd immunity.</div>
        `);
      }

      // Update the bar chart visualization
      function updateChart(district) {
        const chartData = vaccineCols.map(v => ({ vaccine: v, value: district[v] }));
        y.domain(chartData.map(d => d.vaccine));
        x.domain([0, 100]);

        // Update axes
        xAxisG.call(d3.axisBottom(x).ticks(5).tickFormat(d => d + "%"));
        yAxisG.call(d3.axisLeft(y));

        // Bind data to bars
        const bars = g.selectAll(".bar").data(chartData, d => d.vaccine);
        bars.join(
          enter => enter.append("rect")
                        .attr("class", d => d.value < 95 ? "bar low" : "bar")
                        .attr("x", x(0))
                        .attr("y", d => y(d.vaccine))
                        .attr("height", y.bandwidth())
                        .attr("width", 0)
                        .call(e => e.transition().duration(700).attr("width", d => x(d.value))),
          update => update.attr("class", d => d.value < 95 ? "bar low" : "bar")
                          .call(u => u.transition().duration(700)
                                       .attr("y", d => y(d.vaccine))
                                       .attr("height", y.bandwidth())
                                       .attr("width", d => x(d.value))),
          exit => exit.remove()
        )
        .on("mouseover", (event, d) => tooltip.style("opacity", 1).html(`${d.value.toFixed(2)}%`))
        .on("mousemove", event => tooltip.style("left", (event.pageX + 10) + "px")
                                         .style("top", (event.pageY - 20) + "px"))
        .on("mouseout", () => tooltip.style("opacity", 0));

        // Display message about vaccines below 95%
        const low = chartData.filter(d => d.value < 95);
        d3.select("#message")
          .text(low.length ? `Below 95%: ${low.map(d => d.vaccine).join(", ")} — talk to your pediatrician.` 
                           : `All vaccines ≥ 95%. Thank you for protecting your community!`)
          .style("color", low.length ? "var(--red)" : "var(--blue)");
      }
    }).catch(err => {
      console.error(err);
      d3.select("body").append("p")
        .text("Error loading data.csv — make sure it sits next to index.html.")
        .style("color", "var(--red)")
        .style("padding", "1rem");
    });
  </script>
</body>
</html>
