<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lone Star Immunity | An Interactive Data Visualization Created by Kiron Ang</title>
    <style>
      /* Base page styling */
      body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
        color: #333;
      }

      /* Selector bar at top */
      #selector-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        background: #fff;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      #selector-container select,
      #selector-container button {
        font-size: 16px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: border-color .3s, box-shadow .3s;
      }
      #selector-container select:focus,
      #selector-container button:focus {
        outline: none;
        border-color: #d90d0d;
        box-shadow: 0 0 5px rgba(217, 13, 13, 0.4);
      }
      #showDataButton {
        background: #d90d0d;
        color: #fff;
        border: none;
        cursor: pointer;
        transition: background .3s;
      }
      #showDataButton:hover {
        background: #b80b0b;
      }

      /* Chart container styling */
      #chart-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      /* Draw a solid border around the SVG */
      #chart-container svg {
        display: block;
        border: 2px solid #ccc;
        border-radius: 4px;
        overflow: visible;  /* allow tooltips & axis ticks to show */
      }

      /* Tooltip styling */
      .tooltip {
        position: absolute;
        background: rgba(0,0,0,0.75);
        color: #fff;
        padding: 8px;
        border-radius: 4px;
        font-size: 14px;
        pointer-events: none;
        line-height: 1.4;
      }

      /* Axis styling */
      .axis path,
      .axis line {
        stroke: #ccc;
      }
      .axis text {
        fill: #666;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Dropdowns and button for user interaction -->
    <div id="selector-container">
      <select id="county-select"></select> <!-- Populated dynamically -->
      <select id="vaccine-select">
        <option value="Hepatitis A">Hepatitis A</option>
        <option value="Hepatitis B">Hepatitis B</option>
        <option value="Meningococcal">Meningococcal</option>
        <option value="MMR">MMR</option>
        <option value="Polio">Polio</option>
        <option value="Tdap/Td">Tdap/Td</option>
        <option value="Varicella">Varicella</option>
      </select>
      <button id="showDataButton">Make a Chart!</button>
    </div>

    <!-- Container for the D3 chart SVG -->
    <div id="chart-container">
      <svg width="100%" height="500"></svg>
    </div>

    <!-- Include D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      let currentChart = null;

      function addSearchBar(chartGroup) {
        currentChart = chartGroup;
        if (!document.getElementById("school-search-container")) {
          const searchContainer = document.createElement("div");
          searchContainer.id = "school-search-container";
          searchContainer.style.textAlign = "center";
          searchContainer.style.margin = "20px";

          const searchInput = document.createElement("input");
          searchInput.id = "school-search-input";
          searchInput.type = "text";
          searchInput.placeholder = "Search by Facility Name...";
          searchInput.style.padding = "8px";
          searchInput.style.fontSize = "16px";
          searchInput.style.width = "300px";

          searchContainer.appendChild(searchInput);
          document.body.insertBefore(
            searchContainer,
            document.getElementById("chart-container")
          );

          searchInput.addEventListener("input", function () {
            const searchText = searchInput.value.trim().toLowerCase();
            if (currentChart) {
              currentChart
                .selectAll("rect")
                .attr("stroke", d =>
                  d["Facility Name"].toLowerCase().includes(searchText) && searchText
                    ? "#d90d0d"
                    : "none"
                )
                .attr("stroke-width", d =>
                  d["Facility Name"].toLowerCase().includes(searchText) && searchText
                    ? 3
                    : 0
                );
            }
          });
        }
      }

      d3.csv("data.csv").then(data => {
        const uniqueCounties = [...new Set(data.map(d => d.County))].sort();
        const countySelect = document.getElementById("county-select");
        uniqueCounties.forEach(county => {
          const option = document.createElement("option");
          option.text = county;
          option.value = county;
          countySelect.appendChild(option);
        });

        document
          .getElementById("showDataButton")
          .addEventListener("click", () => {
            const svg = d3.select("svg");
            svg.selectAll("*").remove();

            const margin = { top: 10, right: 10, bottom: 30, left: 50 };
            const svgWidth = +svg.node().getBoundingClientRect().width;
            const svgHeight = +svg.node().getBoundingClientRect().height;
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            const chart = svg
              .append("g")
              .attr("transform", `translate(${margin.left},${margin.top})`);

            currentChart = chart;
            addSearchBar(chart);

            const selectedCounty = countySelect.value;
            const selectedVaccine = document.getElementById(
              "vaccine-select"
            ).value;

            const countyData = data.filter(d => d.County === selectedCounty);
            const filteredData = countyData
              .filter(d => d[selectedVaccine] !== "NR")
              .map(d => {
                d[selectedVaccine] = +d[selectedVaccine];
                return d;
              })
              .sort((a, b) => b[selectedVaccine] - a[selectedVaccine]);

            // Y scale & axis
            const yScale = d3.scaleLinear()
              .domain([0, d3.max(filteredData, d => d[selectedVaccine])])
              .range([height, 0]);

            const yAxis = d3.axisLeft(yScale)
              .ticks(5)
              .tickFormat(d => d + "%");

            chart.append("g")
              .attr("class", "axis")
              .call(yAxis);

            // X scale & bar width
            const xScale = d3.scaleBand()
              .domain(filteredData.map(d => d["Facility Name"]))
              .range([0, width])
              .padding(0.1);

            // Draw bars
            chart.selectAll("rect")
              .data(filteredData)
              .enter()
              .append("rect")
              .attr("x", d => xScale(d["Facility Name"]))
              .attr("y", d => yScale(d[selectedVaccine]))
              .attr("width", xScale.bandwidth())
              .attr("height", d => height - yScale(d[selectedVaccine]))
              .attr("fill", "#ffffff")
              .on("mouseover", function(event, d) {
                d3.select(this).attr("fill", "#d90d0d");
                let tooltipHTML = `
                  ${d["Facility Name"]}<br>
                  ${d["School Type"]}<br>
                  ${selectedVaccine}: ${d[selectedVaccine].toFixed(2)}%
                `;
                if (d[selectedVaccine] === 0) {
                  tooltipHTML += `<br>${d["Facility Name"]} has a 0% vaccination rate`;
                }
                const tooltip = d3.select("body")
                  .append("div")
                  .attr("class", "tooltip")
                  .html(tooltipHTML);

                let left = event.pageX;
                let top = event.pageY - tooltip.node().offsetHeight;
                if (left + tooltip.node().offsetWidth > window.innerWidth) {
                  left = event.pageX - tooltip.node().offsetWidth;
                }
                tooltip.style("left", left + "px")
                       .style("top", top + "px");
              })
              .on("mouseout", function() {
                d3.select(this).attr("fill", "#ffffff");
                d3.selectAll(".tooltip").remove();
              });

            // X-axis (optional: rotate labels if too crowded)
            const xAxis = d3.axisBottom(xScale).tickFormat("");
            chart.append("g")
              .attr("class", "axis")
              .attr("transform", `translate(0,${height})`)
              .call(xAxis);
          });
      });
    </script>
  </body>
</html>
