<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Character encoding and responsive viewport settings -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Page title and author metadata -->
  <title>Lone Star Immunity | Interactive Public Health Data Visualization by Kiron Ang</title>
  <meta name="author" content="Kiron Ang" />

  <!-- Include D3.js v7 from CDN for data-driven SVG visualization -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- CSS styles -->
  <style>
    /* CSS custom properties for consistent theming */
    :root {
      --blue:   #0056a9;
      --white:  #ffffff;
      --red:    #d90d0d;
    }
    /* Global box model and reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--white);
      color: var(--blue);
    }
    /* Header and footer styling */
    header, footer {
      text-align: center;
      padding: 1rem;
      background: var(--white);
    }
    header h1 { font-size: 2rem; color: var(--blue); }
    header p  { margin-top: .5rem; }
    footer p  { font-size: .8rem; }

    /* Controls container */
    #controls {
      padding: 1rem;
      background: var(--white);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    /* District search input */
    #district-input {
      width: 80%;
      max-width: 400px;
      padding: .5rem;
      font-size: 1rem;
      border: 2px solid var(--blue);
      border-radius: 4px;
      background: var(--white);
      color: var(--blue);
    }
    /* Info card to display selected district details */
    .info-card {
      width: 80%;
      max-width: 400px;
      background: var(--white);
      border-left: 4px solid var(--blue);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      text-align: left;
      font-size: .95rem;
      color: var(--blue);
    }
    .info-card .label {
      font-weight: bold;
      color: var(--red);
    }

    /* Main chart SVG fills remaining space */
    #chart {
      flex-grow: 1;
      width: 100%;
      height: 100%;
    }
    /* Styles for bars and axes */
    .bar { fill: var(--blue); }
    .bar.low { fill: var(--red); } /* low coverage bars in red */
    .axis path, .axis line { stroke: var(--blue); }
    .axis text { fill: var(--blue); font-size: .9rem; }

    /* Recommended threshold line at 95% */
    .threshold-line {
      stroke: var(--red);
      stroke-dasharray: 4 4;
      stroke-width: 2px;
    }
    .threshold-label {
      fill: var(--red);
      font-size: .9rem;
      text-anchor: end;
    }

    /* Message area styling */
    #message {
      text-align: center;
      padding: .75rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <!-- Page header -->
  <header>
    <h1>Lone Star Immunity</h1>
    <p>Type to search districts &amp; view vaccination coverage</p>
  </header>

  <!-- Controls: search input + info panel -->
  <div id="controls">
    <input
      type="text"
      id="district-input"
      list="district-list"
      placeholder="Start typing district name..."
      autocomplete="off"
    />
    <datalist id="district-list"></datalist>
    <div id="info-panel" class="info-card">
      <!-- Initial prompt before selection -->
      <span class="label">Select a district to see details.</span>
    </div>
  </div>

  <!-- SVG container for D3 chart -->
  <svg id="chart"></svg>

  <!-- Dynamic message about coverage -->
  <div id="message"></div>

  <!-- Page footer -->
  <footer>
    <p>© Kiron Ang</p>
  </footer>

  <!-- JavaScript: D3 data loading and visualization logic -->
  <script>
    // Select the SVG and set margins
    const svg = d3.select("#chart"),
          margin = { top: 40, right: 30, bottom: 120, left: 70 },
          width  = svg.node().clientWidth  - margin.left - margin.right,
          height = svg.node().clientHeight - margin.top  - margin.bottom,
          // Append a <g> translated by the margins
          g = svg
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom + 40}`)
            .style("padding-bottom", "40px")
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

    // Define scales for x (band) and y (linear)
    const x = d3.scaleBand().padding(0.2).range([0, width]),
          y = d3.scaleLinear().range([height, 0]);

    // Create groups for the x- and y-axes
    const xAxisG = g.append("g")
        .attr("class","axis")
        .attr("transform",`translate(0,${height})`);
    const yAxisG = g.append("g").attr("class","axis");

    // Draw a horizontal threshold line at 95%
    g.append("line")
      .attr("class","threshold-line")
      .attr("x1",0).attr("x2",width)
      .attr("y1", y(95)).attr("y2", y(95));
    // Label for the threshold line
    g.append("text")
      .attr("class","threshold-label")
      .attr("x", width)
      .attr("y", y(95)-5)
      .text("95% recommended");

    // Load CSV, parsing percentages and normalizing facility names
    d3.csv("data.csv", d => {
      for (let k in d) {
        if (d[k].endsWith("%")) {
          // Convert "95%" strings to numeric 95
          d[k] = +d[k].replace("%","");
        }
      }
      // Uppercase facility names for consistency
      d["Facility Name"] = d["Facility Name"].toUpperCase();
      return d;
    }).then(data => {
      // Assume vaccine columns start at index 5
      const vaccineCols = data.columns.slice(5);

      // Populate the <datalist> for autocomplete
      d3.select("#district-list")
        .selectAll("option")
        .data(data.map(d => d["Facility Name"]))
        .join("option")
          .attr("value", d => d);

      // Initialize chart/info panel with the first row
      updateAll(data[0]);

      // Listen for user selection in the input
      d3.select("#district-input").on("change", function(){
        const val = this.value.toUpperCase(),
              row = data.find(d => d["Facility Name"] === val);
        if (row) updateAll(row);
      });

      // Update both info panel and chart
      function updateAll(district) {
        updateInfoPanel(district);
        updateChart(district);
      }

      // Fill the info panel with selected district details
      function updateInfoPanel(d) {
        d3.select("#info-panel").html(`
          <div><span class="label">District:</span> ${d["Facility Name"]}</div>
          <div><span class="label">County:</span>   ${d.County}</div>
          <div><span class="label">Type:</span>     ${d["School Type"]}</div>
        `);
      }

      // Render or update the bar chart for the selected district
      function updateChart(district) {
        // Build an array of { vaccine, value } for the bars
        const chartData = vaccineCols.map(v => ({ vaccine: v, value: district[v] }));
        x.domain(chartData.map(d => d.vaccine)); // set x domain to vaccine names
        y.domain([0, 100]);                      // y from 0% to 100%

        // Draw x-axis with rotated labels
        xAxisG.call(d3.axisBottom(x))
              .selectAll("text")
                .attr("transform","rotate(-45)")
                .style("text-anchor","end");
        // Draw y-axis with percent ticks
        yAxisG.call(d3.axisLeft(y).ticks(5).tickFormat(d => d + "%"));

        // DATA JOIN: bind chartData to rectangles
        const bars = g.selectAll(".bar")
          .data(chartData, d => d.vaccine);

        bars.join(
          enter => enter.append("rect")
                        .attr("class", d => d.value < 95 ? "bar low" : "bar")    // low-coverage styling
                        .attr("x", d => x(d.vaccine))
                        .attr("y", y(0))                                         // start from bottom
                        .attr("width", x.bandwidth())
                        .attr("height", 0)                                       // start with zero height
                      .call(enter => enter.transition()
                        .duration(700)
                        .attr("y", d => y(d.value))                             // animate up to value
                        .attr("height", d => height - y(d.value))),
          update => update
                        .attr("class", d => d.value < 95 ? "bar low" : "bar")    // update class
                      .call(update => update.transition()
                        .duration(700)
                        .attr("x", d => x(d.vaccine))
                        .attr("y", d => y(d.value))
                        .attr("width", x.bandwidth())
                        .attr("height", d => height - y(d.value))),
          exit => exit.remove()                                           // remove old bars
        );

        // Build a message about vaccines below threshold
        const low = chartData.filter(d => d.value < 95),
              msg = low.length
                ? `Below 95%: ${low.map(d => d.vaccine).join(", ")} — consult your pediatrician.`
                : `All vaccines ≥ 95%. Thank you for protecting our community!`;

        // Display the message and color it red if any are below threshold
        d3.select("#message")
          .text(msg)
          .style("color", low.length ? "var(--red)" : "var(--blue)");
      }
    })
    .catch(err => {
      // Handle errors loading the CSV (e.g., missing file)
      console.error(err);
      d3.select("body").append("p")
        .text("Error loading data.csv—make sure it sits next to index.html.")
        .style("color", "var(--red)")
        .style("text-align", "center")
        .style("padding", "1rem");
    });
  </script>
</body>
</html>
