<!DOCTYPE html>
<html>
  <head>
    <title>Lone Star Immunity | An Interactive Data Visualization Created by Kiron Ang</title>
    <style>
    </style>
  </head>
  <body>
    <!-- Dropdowns and button for user interaction -->
    <div id="selector-container">
      <select id="county-select"></select> <!-- Populated dynamically -->
      <select id="vaccine-select">
        <!-- Vaccine options -->
        <option value="Hepatitis A">Hepatitis A</option>
        <option value="Hepatitis B">Hepatitis B</option>
        <option value="Meningococcal">Meningococcal</option>
        <option value="MMR">MMR</option>
        <option value="Polio">Polio</option>
        <option value="Tdap/Td">Tdap/Td</option>
        <option value="Varicella">Varicella</option>
      </select>
      <button id="showDataButton">Make a Chart!</button>
    </div>

    <!-- Container for the D3 chart SVG -->
    <div id="chart-container">
      <svg width="100%" height="100%"></svg>
    </div>

    <!-- Include D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      // Track the current chart group for interactivity
      let currentChart = null;

      /**
       * Adds a search bar for facility names above the chart.
       * Highlights bars matching the search text.
       */
      function addSearchBar(chartGroup) {
        currentChart = chartGroup; // Keep reference for filtering

        // Only create search bar once
        if (!document.getElementById("school-search-container")) {
          const searchContainer = document.createElement("div");
          searchContainer.id = "school-search-container";
          searchContainer.style.textAlign = "center";
          searchContainer.style.margin = "20px";

          // Input box for facility name search
          const searchInput = document.createElement("input");
          searchInput.id = "school-search-input";
          searchInput.type = "text";
          searchInput.placeholder = "Search by Facility Name...";
          searchInput.style.padding = "8px";
          searchInput.style.fontSize = "16px";
          searchInput.style.width = "300px";

          searchContainer.appendChild(searchInput);
          document.body.insertBefore(
            searchContainer,
            document.getElementById("chart-container")
          );

          // Filter bars on input
          searchInput.addEventListener("input", function () {
            const searchText = searchInput.value.trim().toLowerCase();
            if (currentChart) {
              currentChart
                .selectAll("rect")
                .attr("stroke", function (d) {
                  // Highlight matching bars
                  return d["Facility Name"]
                    .toLowerCase()
                    .includes(searchText) && searchText
                    ? "#d90d0d"
                    : "none";
                })
                .attr("stroke-width", function (d) {
                  // Thicker border for matches
                  return d["Facility Name"]
                    .toLowerCase()
                    .includes(searchText) && searchText
                    ? 3
                    : 0;
                });
            }
          });
        }
      }

      // Load CSV data and initialize dropdowns
      d3.csv("data.csv").then((data) => {
        // Extract unique county names and sort alphabetically
        const uniqueCounties = [...new Set(data.map((d) => d.County))].sort();
        const countySelect = document.getElementById("county-select");

        // Populate the county dropdown
        uniqueCounties.forEach((county) => {
          const option = document.createElement("option");
          option.text = county;
          option.value = county;
          countySelect.appendChild(option);
        });

        // Draw chart when button is clicked
        document
          .getElementById("showDataButton")
          .addEventListener("click", () => {
            const svg = d3.select("svg");
            svg.selectAll("g").remove(); // Clear previous chart

            // Margins around chart area
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };
            const svgRect = svg.node().getBoundingClientRect();
            const svgWidth = svgRect.width;
            const svgHeight = svgRect.height;
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            // Create group for chart
            const chart = svg
              .append("g")
              .attr("transform", `translate(${margin.left}, ${margin.top})`);

            currentChart = chart;         // Save reference for search filtering
            addSearchBar(chart);          // Add facility search bar

            // Get user selections
            const selectedCounty = countySelect.value;
            const selectedVaccine = document.getElementById(
              "vaccine-select"
            ).value;

            // Filter data by selected county and valid vaccine rates
            const countyData = data.filter((d) => d.County === selectedCounty);
            const filteredData = countyData.filter(
              (d) => d[selectedVaccine] !== "NR"
            );

            // Convert rates to numbers and sort descending
            filteredData.forEach(
              (d) => (d[selectedVaccine] = parseFloat(d[selectedVaccine]))
            );
            filteredData.sort(
              (a, b) => b[selectedVaccine] - a[selectedVaccine]
            );

            const barWidth = width / filteredData.length;

            // Draw bars
            chart
              .selectAll("rect")
              .data(filteredData)
              .enter()
              .append("rect")
              .attr("x", (d, i) => i * barWidth)
              .attr("y", (d) =>
                height - (d[selectedVaccine] / 100) * height
              )
              .attr("width", barWidth)
              .attr("height", (d) =>
                (d[selectedVaccine] / 100) * height
              )
              .attr("fill", "#ffffff")
              .on("mouseover", function (event, d) {
                // Highlight bar and show tooltip
                d3.select(this).attr("fill", "#d90d0d");
                let tooltipHTML = `${d["Facility Name"]}<br>${d["School Type"]}<br>${selectedVaccine}: ${d[
                  selectedVaccine
                ].toFixed(2)}%`;
                if (d[selectedVaccine] === 0) {
                  tooltipHTML += `<br>${d["Facility Name"]} has a 0% vaccination rate`;
                }
                const tooltip = d3
                  .select("body")
                  .append("div")
                  .attr("class", "tooltip")
                  .html(tooltipHTML);

                // Position tooltip near cursor
                let left = event.pageX;
                let top = event.pageY - tooltip.node().offsetHeight;
                // Prevent tooltip from overflowing viewport
                if (
                  left + tooltip.node().offsetWidth >
                  window.innerWidth
                ) {
                  left = event.pageX - tooltip.node().offsetWidth;
                }
                tooltip
                  .style("left", `${left}px`)
                  .style("top", `${top}px`);
              })
              .on("mouseout", function () {
                // Remove highlight and tooltip on mouse out
                d3.select(this).attr("fill", "#ffffff");
                d3.select("body").selectAll(".tooltip").remove();
              });
          });
      });
    </script>
  </body>
</html>
